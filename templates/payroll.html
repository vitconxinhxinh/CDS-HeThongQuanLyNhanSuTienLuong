{% extends "base.html" %}
{% block content %}
<div class="py-3">
  <!-- Header Section with Stats -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card bg-primary bg-gradient text-white h-100">
        <div class="card-body">
          <h6 class="card-title mb-3">Tổng nhân viên</h6>
          <h3 class="mb-0">{{ payroll_data|length }}</h3>
          <div class="small opacity-75">Đang làm việc</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success bg-gradient text-white h-100">
        <div class="card-body">
          <h6 class="card-title mb-3">Tổng ngày làm việc</h6>
          <h3 class="mb-0">{{ num_days }} ngày</h3>
          <div class="small opacity-75">Tháng {{ month }}/{{ year }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <form method="get" action="/payroll" class="row g-3 align-items-end">
            <div class="col-sm-5">
              <label class="form-label fw-medium">Tháng</label>
              <select name="month" class="form-select form-select-lg">
                {% for m in range(1, 13) %}
                <option value="{{ m }}" {% if m == month %}selected{% endif %}>Tháng {{ m }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-sm-5">
              <label class="form-label fw-medium">Năm</label>
              <select name="year" class="form-select form-select-lg">
                {% for y in range(2020, 2031) %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-sm-2">
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-search me-1"></i> Xem
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Payroll Table -->
  <div class="card shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
      <h5 class="mb-0">
        <i class="bi bi-cash-stack text-success me-2"></i>
        Bảng lương tháng {{ month }}/{{ year }}
      </h5>
      <div class="btn-group">
        <button class="btn btn-outline-secondary btn-sm">
          <a href="/payroll/export?month={{ month }}&year={{ year }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-download me-1"></i>Excel
          </a>
        <button class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-printer me-1"></i>In
        </button>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" style="font-size: 0.95rem">
          <thead class="bg-light" style="position: sticky; top: 0; z-index: 1;">
            <tr>
              <th class="py-3" style="min-width: 200px;">Nhân viên</th>
              <th style="min-width: 140px;">Phòng ban</th>
              <th style="min-width: 140px;">Chức vụ</th>
              {% for d in range(1, num_days+1) %}
              {% set is_sunday = (d in sundays) %}
              <th class="text-center px-1 day-header {% if is_sunday %}sunday-header{% endif %}" style="width: 36px;" title="{% if is_sunday %}Chủ Nhật - Lương x2{% else %}Ngày thường{% endif %}">
                <div class="d-flex flex-column align-items-center gap-1">
                  {% if is_sunday %}<i class="bi bi-sun-fill" style="color: #ff9800; font-size: 0.7rem;"></i>{% endif %}
                  <span>{{ d }}</span>
                </div>
              </th>
              {% endfor %}
              <th class="text-end" style="min-width: 140px;">Lương (VNĐ)</th>
              <th class="text-end" style="min-width: 100px;">Sửa</th>
            </tr>
          </thead>
          <tbody>
            {% for row in payroll_data %}
            <tr>
              <td class="py-3">
                <div class="d-flex align-items-center gap-2">
                  <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                    <i class="bi bi-person text-primary"></i>
                  </div>
                  <div>
                    <div class="fw-medium">{{ row.name }}</div>
                    <small class="text-muted">ID: {{ loop.index }}</small>
                  </div>
                </div>
              </td>
              <td>{{ row.department or '—' }}</td>
              <td>{{ row.position or '—' }}</td>
              {% for s in row.days %}
              {% set is_sunday = ((loop.index) in sundays) %}
              <td class="text-center px-1 day-cell {% if is_sunday %}sunday-cell{% endif %}">
                {% if s == '✓' %}
                {% if is_sunday %}
                <div class="d-flex align-items-center justify-content-center gap-1">
                  <i class="bi bi-check-circle-fill text-warning" style="font-size: 0.9rem;"></i>
                </div>
                {% else %}
                <i class="bi bi-check-circle-fill text-success"></i>
                {% endif %}
                {% elif s == 'X' %}
                <i class="bi bi-x-circle-fill text-danger opacity-50"></i>
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </td>
              {% endfor %}
              <td class="text-end fw-medium">{{ '{:,.0f}'.format(row.total_salary) }}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editSalaryModal{{ loop.index }}">
                  <i class="bi bi-pencil-square"></i> Sửa
                </button>
                <!-- Modal chỉnh sửa chấm công -->
                <div class="modal fade" id="editSalaryModal{{ loop.index }}" tabindex="-1" aria-labelledby="editSalaryLabel{{ loop.index }}" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <form method="post" action="/payroll/update">
                        <div class="modal-header bg-light border-bottom">
                          <div>
                            <h5 class="modal-title" id="editSalaryLabel{{ loop.index }}">Chỉnh sửa ngày chấm công</h5>
                            <small class="text-muted d-block mt-1">{{ row.name }} - {{ row.department }}</small>
                          </div>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                          <input type="hidden" name="employee_name" value="{{ row.name }}">
                          <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Lưu ý:</strong> Những ngày chủ nhật (có icon <i class="bi bi-sun-fill" style="color: #ff9800;"></i>) sẽ được tính lương gấp đôi
                          </div>
                          <div class="row g-2">
                            {% for d in range(1, num_days+1) %}
                            {% set is_sunday = (d in sundays) %}
                            <div class="col-6 col-md-4 col-lg-3">
                              <div class="card border-light day-card {% if is_sunday %}sunday-card-modal{% endif %}">
                                <div class="card-body p-2">
                                  <label class="form-label mb-2 d-block text-center fw-bold">
                                    <span class="badge {% if is_sunday %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ d }}</span>
                                    {% if is_sunday %}<span class="d-block mt-1"><i class="bi bi-sun-fill" style="color: #ff9800; font-size: 1rem;"></i></span>{% endif %}
                                  </label>
                                  <select class="form-select form-select-sm" name="day_status_{{ d }}">
                                    <option value="✓" {% if row.days[d-1] == '✓' %}selected{% endif %}>
                                      ✓ Đi làm
                                    </option>
                                    <option value="X" {% if row.days[d-1] == 'X' %}selected{% endif %}>
                                      ✗ Nghỉ
                                    </option>
                                    <option value="-" {% if row.days[d-1] == '-' %}selected{% endif %}>— Không xác định</option>
                                  </select>
                                </div>
                              </div>
                            </div>
                            {% endfor %}
                          </div>
                        </div>
                        <div class="modal-footer border-top">
                          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                          <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i> Lưu thay đổi
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </td
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Add Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
/* Custom styles */
.table > :not(caption) > * > * {
  padding: 0.75rem 1rem;
}
.bg-light {
  background-color: #f8f9fa !important;
}
.table-hover tbody tr:hover {
  background-color: #f8f9fa;
}
.card {
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  border: 1px solid rgba(0, 0, 0, 0.05);
}

/* Modal customization */
.modal-body {
  background-color: #f8f9fa;
}

.modal-body .card {
  background-color: white;
  border: 1px solid #dee2e6;
  transition: all 0.3s ease;
}

.modal-body .card:hover {
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  transform: translateY(-2px);
}

.form-select-sm {
  padding: 0.375rem 0.75rem;
  font-size: 0.875rem;
}

/* Form select styling */
.form-select:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-select-lg {
  padding: 0.75rem 1rem;
  font-size: 1rem;
}

/* Sunday highlighting */
.day-header {
  font-weight: 500;
  letter-spacing: 0.3px;
  transition: background-color 0.2s ease;
}

.sunday-header {
  font-weight: 600;
  color: #333;
}

.day-cell {
  transition: all 0.2s ease;
}

.day-cell:hover {
  background-color: #f5f5f5;
}

.sunday-cell {
  background-color: white !important;
}

.day-card {
  background-color: white;
  border: 1px solid #e0e0e0;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.day-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
  border-color: #90caf9;
}

.sunday-card-modal {
  background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%) !important;
}

.sunday-card-modal:hover {
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.25);
}
</style>
{% endblock %}
